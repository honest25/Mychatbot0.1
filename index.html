<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Universal AI Chat • Debug Mode</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- marked.js for markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; background: #f8fafc; color: #0f172a; }
    .dark { background: #0f172a; color: #f8fafc; }
    #loading { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.4s; }
    .dark #loading { background: #0f172a; color: white; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Loading screen -->
  <div id="loading">
    <div class="text-xl font-bold animate-pulse">Initializing Advanced AI Chat...</div>
  </div>

  <div id="app" class="flex-1 flex flex-col opacity-0 transition-opacity duration-500 p-4 max-w-4xl mx-auto">

    <h1 class="text-3xl font-bold text-center mb-6 text-sky-600">AI Chat (Debug Mode)</h1>

    <div id="messages" class="flex-1 overflow-y-auto border rounded-lg p-4 mb-4 bg-white dark:bg-gray-800 min-h-[300px]">
      <p class="text-center text-gray-500">Welcome! Type below to start chatting.</p>
    </div>

    <form id="chat-form" class="flex gap-2">
      <textarea id="user-input" rows="2" placeholder="Ask anything..." class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 resize-none"></textarea>
      <button type="submit" id="send-btn" class="px-6 py-3 bg-sky-600 text-white rounded-lg hover:bg-sky-700 disabled:opacity-50" disabled>Send</button>
    </form>

    <div id="status" class="mt-4 text-sm text-gray-600 dark:text-gray-400 text-center"></div>
  </div>

  <!-- Settings (minimal) -->
  <div class="p-4 border-t">
    <h2 class="text-lg font-semibold mb-2">Quick Settings</h2>
    <input type="password" id="api-key" placeholder="OpenRouter API Key" class="w-full p-2 mb-2 border rounded">
    <input type="text" id="model" value="qwen/qwen2.5-coder-7b-instruct:free" placeholder="Model" class="w-full p-2 mb-2 border rounded">
    <button id="save-settings" class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700">Save & Reload</button>
  </div>

  <script>
    console.log("=== SCRIPT STARTED ===", new Date().toISOString());

    const loading = document.getElementById('loading');
    const app = document.getElementById('app');
    const messages = document.getElementById('messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const form = document.getElementById('chat-form');
    const apiKeyInput = document.getElementById('api-key');
    const modelInput = document.getElementById('model');
    const saveBtn = document.getElementById('save-settings');
    const status = document.getElementById('status');

    console.log("DOM elements grabbed");

    // Force hide loader after 8 seconds no matter what
    setTimeout(() => {
      console.log("FORCE HIDE triggered after timeout");
      if (loading) {
        loading.style.opacity = '0';
        setTimeout(() => { loading.style.display = 'none'; }, 400);
      }
      if (app) app.classList.remove('opacity-0');
      if (status) status.innerHTML += '<br><span style="color:orange">Loader auto-hidden after timeout</span>';
    }, 8000);

    // Basic dark mode toggle (for testing)
    document.documentElement.classList.toggle('dark', window.matchMedia('(prefers-color-scheme: dark)').matches);

    console.log("Basic setup done");

    function addMessage(role, content) {
      console.log("Adding message:", role, content.substring(0,50) + "...");
      const div = document.createElement('div');
      div.className = role === 'user' ? 'text-right mb-3' : 'text-left mb-3';
      div.innerHTML = `<div class="inline-block p-3 rounded-lg ${role === 'user' ? 'bg-sky-100' : 'bg-gray-100 dark:bg-gray-700'} max-w-[80%]">${content}</div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // Send message
    if (form) {
      form.onsubmit = async e => {
        e.preventDefault();
        const text = userInput.value.trim();
        if (!text) return;

        addMessage('user', text);
        userInput.value = '';
        sendBtn.disabled = true;

        const key = apiKeyInput.value.trim();
        const model = modelInput.value.trim() || 'qwen/qwen2.5-coder-7b-instruct:free';

        if (!key) {
          addMessage('assistant', 'Error: Please enter your OpenRouter API key first.');
          return;
        }

        addMessage('assistant', 'Thinking...');

        try {
          console.log("Sending API request to model:", model);
          const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify({
              model,
              messages: [{ role: 'user', content: text }],
              stream: false
            })
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const reply = data.choices?.[0]?.message?.content || 'No reply received';

          messages.lastChild.querySelector('div').textContent = reply;
          console.log("Response received");
        } catch (err) {
          console.error("API error:", err);
          messages.lastChild.querySelector('div').innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
        }

        sendBtn.disabled = false;
      };
    }

    if (userInput) {
      userInput.oninput = () => {
        sendBtn.disabled = !userInput.value.trim();
      };
    }

    if (saveBtn) {
      saveBtn.onclick = () => {
        console.log("Settings saved – reloading");
        localStorage.setItem('apiKey', apiKeyInput.value.trim());
        localStorage.setItem('model', modelInput.value.trim());
        location.reload();
      };
    }

    // Load saved key/model if any
    if (apiKeyInput) apiKeyInput.value = localStorage.getItem('apiKey') || '';
    if (modelInput) modelInput.value = localStorage.getItem('model') || 'qwen/qwen2.5-coder-7b-instruct:free';

    // Show success if we reach here
    console.log("Script reached end – should be visible now");
    if (status) status.innerHTML = 'JavaScript is running! → Type a message and send.<br><small>Check console (F12) for logs</small>';
    if (loading) {
      loading.style.opacity = '0';
      setTimeout(() => loading.style.display = 'none', 400);
    }
    if (app) app.classList.remove('opacity-0');

  </script>
</body>
</html>
